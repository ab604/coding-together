# Data wrangling I {#data-wrangle-1}

By the end of this chapter you will:

+ have learnt to load and export csv and excel files
+ know what tidy data is and how to organise data such that it is tidy 
+ have used the key verbs of the `dplyr` package for transforming data to
arrange and filter observations, select variables, create new variables, and
create summaries.
+ have learnt how to combine functions with the pipe from the `magrittr` package 
to combine tasks

The following sections are based upon the [data transformation chapter](https://r4ds.had.co.nz/transform.html) in R4DS and the 
[Data Carpentry ecology lesson](https://datacarpentry.org/R-ecology-lesson/index.html).

## Data organisation in spreadsheets

Karl Broman and Kara Woo wrote as 
paper all about [Data Organization in Spreadsheets](https://www.tandfonline.com/doi/full/10.1080/00031305.2017.1375989).

It's full of practical advice and context.

### Flat formats and Excel files

File formats like `.csv` and `.tsv`, comma separated variables and tab separated variables
respectively are plain text files. That is to 
say they contain only the data, as text information, and are the simplest and most convenient way to share data as most software can read and 
interpret them.

Excel files saves files into its own proprietary format viz xls or xlsx that holds information in addition to the data itself. For reading and
writing excel files in R, the tidyverse `readxl` package is very useful.

## The Portal Project data

In this chapter we are going to focus on data analysed 
in the 1994 paper by Heske et. al: 

**Long-Term Experimental Study of a Chihuahuan Desert Rodent Community: 13 Years 
of Competition**, DOI: 10.2307/1939547.

Specifically they explored the effect on the populations of small
seed eating rodents as a result of the exclusion of larger competitor kangaroo rats over a period from 1977 to 1991.

Figure \@ref(fig:k-rat) shows an image of one of the species of kangaroo rats excluded during the
study.

(ref:krat) [Merriam's kangaroo rat, Dipodomys merriami](https://portalproject.wordpress.com/)


```{r k-rat, fig.cap='(ref:krat)',fig.asp=1, fig.align='center', echo=FALSE,cache=TRUE}
knitr::include_graphics("img/kratsep12.jpg")
```

Figure \@ref(fig:fence) indicates how the exclusion works, where a for number of
fenced plots the kangaroo rats were either able to enter by a hole or kept out.

(ref:fence) Kangeroo Rat exclusion

```{r fence,  fig.cap='(ref:fence)',fig.asp=1, out.width= '50%', fig.align='center', echo=FALSE,cache=TRUE}
knitr::include_graphics("img/fence_hole.JPG")
```

The plots are 50 metres by 50 metres, and a survey of the species within each
plot has been ongoing once a month for many years.

The dataset is stored as a comma separated value (CSV) file.
Each row holds information for a single animal, and the columns represent:

| Column           | Description                        | Type      |
|------------------|------------------------------------|-----------|
| record\_id       | Unique id for the observation      | numeric   |
| month            | month of observation               | numeric   |
| day              | day of observation                 | numeric   |
| year             | year of observation                | numeric   |
| plot\_id         | ID of a particular plot            | numeric   |
| species\_id      | 2-letter code                      | character |
| sex              | sex of animal ("M", "F")           | character |
| hindfoot\_length | length of the hindfoot in mm       | numeric   |
| weight           | weight of the animal in grams      | numeric   |
| genus            | genus of animal                    | character |
| species          | species of animal                  | character |
| taxa             | e.g. Rodent, Reptile, Bird, Rabbit | character |
| plot\_type       | type of plot                       | character |

The rodents species surveyed are:

**Kangeroo Rats**                                                     

| species_id | Scientific name       | Common name                  |
|------------|-----------------------|------------------------------|
| DM         | Dipodomys merriami    | Merriam's kangaroo rat       |
| DO         | Dipodomys ordii       | Ord's kangaroo rat           |
| DS         | Dipodomys spectabilis | Banner-tailed kangaroo rat   |

**Granivores**                                                        

| species_id | Scientific name           | Common name              |
|------------|---------------------------|--------------------------|
| PP         | Chaetodipus penicillatus  | Desert pocket mouse      |
| PF         | Perognathus flavus        | Silky pocket mouse       |
| PE         | Peromyscus eremicus       | Cactus mouse             |
| PM         | Peromyscus maniculatus    | Deer Mouse               |
| RM         | Reithrodontomys megalotis | Western harvest mouse    |

### Downloading and importing the data 

**First create a R project for this analysis**

The dataset is stored online, so we use the utility function 
`download.file()` to download the csv file to our data folder. 
(Did you create a data folder in the project directory?)

Here we pass the `url = ` and `destfile = ` arguments to `download.file()`.

As we have the `tidyverse` packages we can use the `readr` package it contains, which has many functions for reading files, including `read_csv()`.
The advantage of `read_csv()` over base R `read.csv()` is that it defaults to reading strings as
character vectors rather than factors (catergorical variables) which 
is usually what we want.

As we read the data into our environment we need to assign a label 
to the object we are creating. Here we assign the dataset to an object 
called `surveys` using the `<-` assignment operator.

```{r download-portal-data, eval=FALSE}
# Download the data
download.file(url="https://ndownloader.figshare.com/files/2292169",
              destfile = "data/portal_data_joined.csv")

# Read into R as an object called surveys
surveys <- read_csv("data/portal_data_joined.csv")
```

## dplyr

### Filter rows with `filter()`

The first verb to consider is the `filter()` function which enables us to subset observations
based on their value.

Consider the surveys data and sub-setting observations that only occurred from
1985 onwards. It's fairly natural to say *"filter the survey where the year
variable is equal or greater than 1985"*. And indeed this is how we use `filter()`
as a verb. 

Figure \@ref(fig:dplyr-filter) shows how 
we give the filter function two arguments. The first is the
data frame, the second is the variable and condition on which we wish to filter.

Alternatively we can pipe the `surveys` object
to the function and it implicitly uses `surveys`
as the first argument.

(Note that we aren't assigning the output to an object here, so we can see it.)

(ref:filter) `dplyr::filter()`

```{r dplyr-filter, fig.cap='(ref:filter)',fig.asp=1, out.width= '80%', fig.align='center', echo=FALSE,cache=TRUE}

knitr::include_graphics("img/dplyr_filter.png")
```


```{r filter}
# Filter observations that only occurred from 1985 onwards
 filter(surveys, year >= 1985)
```

```{r}
# Control Plots: 2,8,12,22
# Treatment Plots: 3,15,19,21

# Create a vector for the experimental plots
exp_plots <- c(8,11,12,14,3,15,19,21)

# Keep only the rows corresponding with the experimental plot_id's
surveys_filtered <- surveys %>% filter(plot_id %in% exp_plots)
```


### Arrange rows with `arrange()`

(ref:arrange) `dplyr::arrange()`

```{r dplyr-arrange, fig.cap='(ref:arrange)',fig.asp=1, out.width= '80%', fig.align='center', echo=FALSE,cache=TRUE}
knitr::include_graphics("img/dplyr_arrange.png")
```

Use arrange to find the shortest hindfoot 

```{r arrange-short-foot}
surveys %>% arrange(hindfoot_length)
```

Find the Cactus Mouse, (`species_id == "PE"`) with the longest hindfoot:

*Hint* Use the `desc()` function to arrange from biggest to smallest.

```{r}
surveys %>% 
        filter(species_id == "PE") %>% 
        arrange(desc(hindfoot_length))
```


### Select columns with `select()`

(ref:select) `dplyr::select()`

```{r dplyr-select, fig.cap='(ref:select)',fig.asp=1, out.width= '80%', fig.align='center', echo=FALSE,cache=TRUE}
knitr::include_graphics("img/dplyr_select.png")
```

```{r select}
# Select the year and plot type columns
surveys %>% select(year,plot_type)
```

```{r}
# Select everything except sex, hindfoot and weight
surveys_selected <- surveys_filtered %>% select(-sex,-hindfoot_length,-weight)
```


### Create new variables with `mutate()`

(ref:mutate) `dplyr::mutate()`

```{r dplyr-mutate, fig.cap='(ref:mutate)',fig.asp=1, out.width= '80%', fig.align='center', echo=FALSE,cache=TRUE}
knitr::include_graphics("img/dplyr_mutate.png")
```

```{r}
# Mutate surveys_selected
surveys_mutated <- surveys_selected %>%
  #filter(species_id %in% names(lut)) %>% 
  mutate(rodent_type = case_when(
         species_id == "DM" ~ "Kangaroo Rat",
         species_id == "DO" ~ "Kangaroo Rat",
         species_id == "DS" ~ "Kangaroo Rat",
         species_id == "PP" ~ "Granivore",
         species_id == "PF" ~ "Granivore",
         species_id == "PE" ~ "Granivore",
         species_id == "PM" ~ "Granivore",
         species_id == "RM" ~ "Granivore",
         TRUE ~ "Other"))
 
# Check the output using a summary pipe, we should have 8 species of 2 types
surveys_mutated %>% group_by(species_id,rodent_type) %>% summarise()
```

### Grouped summaries with `group_by()` and `summarise()`

(ref:gb-summarise) `dplyr::group_by()` and `dplyr::summarise()`

```{r dplyr-gb-summarise, fig.cap='(ref:gb-summarise)', fig.show='hold',fig.align='center', echo=FALSE,cache=TRUE}
knitr::include_graphics("img/dplyr_summarise.png")

knitr::include_graphics("img/dplyr_group_by.png")
```

```{r}
library(lubridate)
surveys_subset <- surveys_mutated %>% 
        mutate(date = make_date(day = day, month = month, year = year), 
               quarter = quarter(date,with_year = TRUE)) %>%
        filter(!is.na(rodent_type))
```

```{r}
by_quarter <- surveys_subset %>% 
        group_by(rodent_type,plot_type,quarter) %>% 
        summarise(captures = n()/4)
```

```{r}
ggplot(by_quarter,
       aes(x=quarter,y=captures,colour=rodent_type)) +
  geom_line() +
  geom_point() +
  facet_wrap(~ plot_type)
```

```{r}
by_quarter %>% 
        filter(rodent_type != "Other") %>% 
        ggplot(aes(x=quarter,y=captures,colour=rodent_type)) +
  geom_line() +
  geom_point() +
  facet_wrap(~ plot_type) +
        theme(legend.position = "bottom")
```
